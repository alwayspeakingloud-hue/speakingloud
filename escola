<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>√Årea da Escola</title>

<style>


.horarios-layout {
  display: grid;
  grid-template-columns: 380px 1fr;
  gap: 24px;
  align-items: start;
}

.horarios-form {
  position: sticky;
  top: 20px;
}

.horarios-calendario {
  overflow-x: auto;
}

.horarios-calendario .card {
  max-width: 100%;
}

.calendario-grade {
  min-width: 700px;
  border-radius: 12px;
}


.aluno-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    font-weight: bold;
}

.seta {
    width: 0;
    height: 0;
    border-top: 6px solid transparent;
    border-bottom: 6px solid transparent;
    border-left: 8px solid #111;
    transition: transform 0.3s ease;
}

/* aberto ‚Üí seta para baixo */
.aluno-header.aberto .seta {
    transform: rotate(90deg);
}

.boletos {
    display: none;
    margin-top: 15px;
}

body {
    margin: 0;
    font-family: "Segoe UI", Arial, sans-serif;
    background: #f1f5f9;
}
header {
    background: linear-gradient(90deg, #7f1d1d, #991b1b);
    color: white;
    padding: 24px;
}
.container {
    display: flex;
    height: calc(100vh - 88px);
}
.menu {
    width: 260px;
    background: white;
    border-right: 1px solid #e5e7eb;
    padding: 20px;
}
.menu button {
    width: 100%;
    padding: 12px;
    margin-bottom: 10px;
    border: none;
    background: #f1f5f9;
    cursor: pointer;
    text-align: left;
    border-radius: 8px;
    transition: .25s;
}
.menu button:hover {
    background: #fee2e2;
    transform: translateX(6px);
}
.content {
  flex: 1;
  padding: 30px;
  background: #f8fafc;
  overflow: hidden; /* üî• IMPORTANTE */
}

#horarios .card {
  overflow: hidden;
}

.section { display: none; }
.section.active { display: block; }
.card, .level {
    background: white;
    padding: 22px;
    border-radius: 14px;
    margin-bottom: 24px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.06);
}
input, select, textarea {
    width: 100%;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 8px;
    border: 1px solid #d1d5db;
}
button.primary {
    background: #991b1b;
    color: white;
    border: none;
    padding: 12px;
    border-radius: 8px;
    cursor: pointer;
}
button.edit {
    background: #2563eb;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
}
button.delete {
    background: #dc2626;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
}
table {
    width: 100%;
    border-collapse: collapse;
}
th, td {
    padding: 10px;
    border: 1px solid #e5e7eb;
}
tr.basico { background: #eff6ff; }
tr.intermediario { background: #ecfdf5; }
tr.avancado { background: #fef2f2; }

/* ================= RESPONSIVO ================= */
  @media (max-width: 768px) {

    .container {
      flex-direction: column;
      height: auto;
    }

    .menu {
      width: 100%;
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding: 10px;
    }

    .menu button {
      flex: 1;
      white-space: nowrap;
      font-size: 14px;
      padding: 10px;
    }

    .content {
      padding: 15px;
    }

    table {
      display: block;
      overflow-x: auto;
      white-space: nowrap;
    }

    input, select, textarea, button {
      font-size: 16px;
    }

    button {
      padding: 14px;
    }

    .card {
      padding: 16px;
      margin-bottom: 16px;
    }

    .aluno-header {
      font-size: 16px;
    }
  }

.horarios-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 16px;
  margin-top: 16px;
}

.horario-card {
  background: #ffffff;
  border-radius: 14px;
  padding: 16px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.06);
}

.horario-card h4 {
  margin-bottom: 10px;
}

.calendario-semana {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 12px;
  margin-top: 16px;
}

.dia-coluna {
  background: #fff;
  border-radius: 12px;
  padding: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,.06);
}

.dia-coluna h4 {
  text-align: center;
  margin-bottom: 8px;
  border-bottom: 1px solid #e5e7eb;
  padding-bottom: 6px;
}

.aula {
  background: #fee2e2;
  border-radius: 8px;
  padding: 6px;
  margin-bottom: 6px;
  font-size: 13px;
}

.calendario-grade {
  max-height: calc(100vh - 260px); /* ajusta ao header + cards */
  overflow-y: auto;
}

.cabecalho, .hora {
  background: #f1f5f9;
  font-weight: bold;
}

.celula {
  border: 1px solid #e5e7eb;
  padding: 6px;
  min-height: 60px;
  font-size: 12px;
}

.aula-grade {
  background: #fee2e2;
  border-radius: 6px;
  padding: 4px;
  margin-bottom: 4px;
}

</style>
</head>

<body>

<header>
<h1>√Årea da Escola</h1>
<p>Gest√£o Acad√™mica</p>
</header>

<div class="container">

<div class="menu">
    <button onclick="mostrar('inicio')">üè† In√≠cio</button>
    <button onclick="mostrar('alunos')">üë©‚Äçüéì Alunos</button>
    <button onclick="mostrar('pagamentos')">üí∞ Pagamentos</button>
    <button onclick="mostrar('tarefas')">üìù Tarefas</button>
    <button onclick="mostrar('projetos')">üìÅ Projetos Externos</button>
    <button onclick="mostrar('calendario')">üìÖ Calend√°rio</button>
    <button onclick="mostrar('horarios')">üïí Hor√°rios</button>
</div>

<!-- ================= HOR√ÅRIOS ================= -->
<div id="horarios" class="section">

  <div class="horarios-layout">

    <div class="horarios-form">
      <div class="card">
        <h2>Cadastro de Hor√°rio</h2>

        <select id="alunoHorario"></select>
        <select id="tipoAula">
          <option value="">Tipo de aula</option>
          <option value="particular">Particular</option>
          <option value="turma">Turma</option>
        </select>

        <select id="qtdAulas" onchange="gerarHorarios()">
          <option value="">Vezes por semana</option>
          <option value="1">1x</option>
          <option value="2">2x</option>
          <option value="3">3x</option>
          <option value="4">4x</option>
        </select>

        <div id="horariosSemana"></div>

        <button class="primary" onclick="salvarHorario()">Salvar hor√°rios</button>
      </div>
    </div>

    <div class="horarios-calendario">
      <div class="card">
        <h2>Hor√°rios cadastrados</h2>
        <div id="listaHorarios"></div>
      </div>
    </div>

  </div>

</div>

<!-- ================= ALUNOS ================= -->
<div id="alunos" class="section">
  <div class="card">
    <h2>Cadastrar / Editar Aluno</h2>

    <input id="alunoNome" placeholder="Nome completo">
    <input id="alunoCpf" placeholder="CPF">

    <select id="alunoNivel">
      <option value="">Selecione o n√≠vel</option>
      <option value="basico">B√°sico</option>
      <option value="intermediario">Intermedi√°rio</option>
      <option value="avancado">Avan√ßado</option>
    </select>

    <button class="primary" onclick="salvarAluno()">Salvar aluno</button>
  </div>

  <div class="card">
    <h2>Alunos cadastrados</h2>
    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>CPF</th>
          <th>N√≠vel</th>
          <th>Login</th>
          <th>Senha</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="listaAlunos"></tbody>
    </table>
  </div>
</div>


<!-- ================= PAGAMENTOS ================= -->
<div id="pagamentos" class="section">

  <div class="card">
    <h2>Boletos por aluno</h2>
    <div id="listaBoletosPorAluno"></div>
  </div>

</div>

<!-- ================= TAREFAS (ADICIONADO) ================= -->
<div id="tarefas" class="section">

<div class="card">
<h2>Adicionar tarefa</h2>
<input id="unidadeTarefa" placeholder="Nome da unidade">
<input id="nomeTarefa" placeholder="Nome da tarefa">
<select id="nivelTarefa">
<option value="">N√≠vel</option>
<option value="basico">B√°sico</option>
<option value="intermediario">Intermedi√°rio</option>
<option value="avancado">Avan√ßado</option>
</select>
<input type="file" id="arquivoTarefa">
<button class="primary" onclick="addTarefa()">Salvar tarefa</button>
</div>

<div id="listaTarefasAdmin"></div>

</div>

<!-- ================= PROJETOS ================= -->
<div id="projetos" class="section">

<div class="card">
<h2>Adicionar projeto externo</h2>

<select id="nivelProjeto">
<option value="">Selecione o n√≠vel</option>
<option value="basico">B√°sico</option>
<option value="intermediario">Intermedi√°rio</option>
<option value="avancado">Avan√ßado</option>
</select>

<input id="nomeProjeto" placeholder="Nome do projeto">

<textarea id="descProjeto" placeholder="Descri√ß√£o do projeto"></textarea>

<input type="file" id="arquivoProjeto">

<button class="primary" onclick="salvarProjeto()">Salvar projeto</button>
</div>

<div id="listaProjetos"></div>

</div>

<!-- ================= CALEND√ÅRIO ================= -->
<div id="calendario" class="section">
<div class="card">
<button class="primary" onclick="adicionarMes()">‚ûï Pr√≥ximo m√™s</button>
</div>
<div id="listaMeses"></div>
</div>

</div>
</div>

<script type="module">

import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  doc,
  updateDoc,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

import { onAuthStateChanged } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";


/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCxeGPkMp6MtrIDYtSqq31xhrEnExq5xf8",
  authDomain: "speaking-loud.firebaseapp.com",
  projectId: "speaking-loud",
  storageBucket: "speaking-loud.firebasestorage.app",
  messagingSenderId: "1002979647448",
  appId: "1:1002979647448:web:6dc375319cd8ac3aeadcad",
  measurementId: "G-7LSB30922J"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "../index.html";
  }
});
const db = getFirestore(app);

// ================= DOM =================
const listaAlunos = document.getElementById("listaAlunos");

const listaTarefasAdmin = document.getElementById("listaTarefasAdmin");
const listaProjetos = document.getElementById("listaProjetos");
const listaMeses = document.getElementById("listaMeses");

const unidadeTarefa = document.getElementById("unidadeTarefa");
const nomeTarefa = document.getElementById("nomeTarefa");
const nivelTarefa = document.getElementById("nivelTarefa");
const arquivoTarefa = document.getElementById("arquivoTarefa");

const nivelProjeto = document.getElementById("nivelProjeto");
const nomeProjeto = document.getElementById("nomeProjeto");
const descProjeto = document.getElementById("descProjeto");
const arquivoProjeto = document.getElementById("arquivoProjeto");

const mesBoleto = document.getElementById("mesBoleto");
const vencimentoBoleto = document.getElementById("vencimentoBoleto");
const pixBoleto = document.getElementById("pixBoleto");
const arquivoBoleto = document.getElementById("arquivoBoleto");

const listaBoletosPorAluno = document.getElementById("listaBoletosPorAluno");

let secondaryAuth;
let alunoEditandoId = null;

try {
  const secondaryApp = initializeApp(firebaseConfig, "SecondaryAluno");
  secondaryAuth = getAuth(secondaryApp);
} catch (e) {
  secondaryAuth = getAuth(getApps().find(app => app.name === "SecondaryAluno"));
}

/* ================= RENDER ALUNOS ================= */
async function renderAlunosFirestore() {
    listaAlunos.innerHTML = "";

    const snapshot = await getDocs(collection(db, "alunos"));

    snapshot.forEach((docSnap) => {
        const a = docSnap.data();
        const id = docSnap.id;

        listaAlunos.innerHTML += `
        <tr class="${(a.nivel || "").toLowerCase()}">
            <td>${a.nome}</td>
            <td>${a.cpf || "-"}</td>
            <td>${a.nivel}</td>
            <td>${a.login}</td>
            <td>${a.senha || "‚Äî"}</td>
            <td>
                <button class="edit"
                    onclick="editarAluno('${id}', '${a.nome}', '${a.cpf}', '${a.nivel}')">
                    Editar
                </button>
                <button class="delete"
                    onclick="excluirAluno('${id}', '${a.nome}')">
                    Excluir
                </button>
            </td>
        </tr>`;
    });
}


function gerarLogin(nome) {
    return nome
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z ]/g, "")
        .trim()
        .split(" ")
        .slice(0, 2)
        .join(".");
}

function gerarSenha() {
    return Math.random().toString(36).slice(-8);
}


/* SALVAR ALUNO ‚Äî FIRESTORE */
window.salvarAluno = async function () {
  const nomeInput = document.getElementById("alunoNome");
  const cpfInput = document.getElementById("alunoCpf");
  const nivelInput = document.getElementById("alunoNivel");

  // ‚úèÔ∏è EDITAR ALUNO
  if (alunoEditandoId) {
    try {
      await updateDoc(doc(db, "alunos", alunoEditandoId), {
        nome: nomeInput.value,
        cpf: cpfInput.value,
        nivel: nivelInput.value
      });

      alert("Aluno atualizado com sucesso!");

      alunoEditandoId = null;
      nomeInput.value = "";
      cpfInput.value = "";
      nivelInput.value = "";

      renderAlunosFirestore();
      return;
    } catch (e) {
      console.error(e);
      alert("Erro ao editar aluno");
      return;
    }
  }


  const loginAluno = gerarLogin(nomeInput.value);
  const senhaAluno = gerarSenha();
  const emailFirebase = loginAluno + "@speakingloud.com";

  try {

    // ‚úÖ CRIA USU√ÅRIO NO AUTH
    await createUserWithEmailAndPassword(
      secondaryAuth,
      emailFirebase,
      senhaAluno
    );

    // ‚úÖ SALVA NO FIRESTORE
    await addDoc(collection(db, "alunos"), {
      nome: nomeInput.value,
      cpf: cpfInput.value,
      nivel: nivelInput.value,
      login: loginAluno,
      senha: senhaAluno, // üëà AQUI
      criadoEm: new Date()
    });

    alert(
      `Aluno criado com sucesso!\n\nLogin: ${loginAluno}\nSenha: ${senhaAluno}`
    );

    nomeInput.value = "";
    cpfInput.value = "";
    nivelInput.value = "";

    renderAlunosFirestore();

  } catch (error) {
    console.error("ERRO AO CRIAR ALUNO:", error);
    alert(error.message);
  }
};

/* ================= PAGAMENTOS ================= */
/* ================= RENDER BOLETOS ================= */
async function renderBoletosPorAluno() {
  listaBoletosPorAluno.innerHTML = "";

  const alunosSnap = await getDocs(collection(db, "alunos"));
  const boletosSnap = await getDocs(collection(db, "boletos"));

  const boletosPorAluno = {};

  boletosSnap.forEach(docSnap => {
    const b = docSnap.data();
    if (!boletosPorAluno[b.alunoLogin]) {
      boletosPorAluno[b.alunoLogin] = [];
    }
    boletosPorAluno[b.alunoLogin].push({ ...b, id: docSnap.id });
  });

  alunosSnap.forEach(alunoDoc => {
    const aluno = alunoDoc.data();
    const login = aluno.login;

    const boletos = boletosPorAluno[login] || [];

    const boxId = `boletos-${login}`;

    listaBoletosPorAluno.innerHTML += `
      <div class="card">
        <div class="aluno-header" onclick="toggleBoletos('${boxId}', this)">
          ${aluno.nome} (${login})
          <span class="seta"></span>
        </div>

        <div class="boletos" id="${boxId}">
          <div style="margin:15px 0">
            <input placeholder="M√™s do boleto" id="mes-${login}">
            <input type="date" id="venc-${login}">
            <input placeholder="PIX" id="pix-${login}">
            <input type="file" id="file-${login}">
            <button class="primary" onclick="salvarBoletoAluno('${login}')">
              ‚ûï Adicionar boleto
            </button>
          </div>

${
  boletos.length === 0
    ? "<p>Nenhum boleto cadastrado.</p>"
    : boletos.map(b => `
      <div style="border-top:1px solid #e5e7eb;padding-top:10px;margin-top:10px">
        <strong>${b.mes}</strong><br>
        Vencimento: ${b.vencimento}<br>

        <p>
          Status:
          <strong style="color:${b.status === "pago" ? "green" : "red"}">
            ${b.status === "pago" ? "PAGO" : "PENDENTE"}
          </strong>
        </p>

        <a href="${b.arquivo}" download>üìÑ Baixar</a><br><br>

        ${
          b.status !== "pago"
            ? `<button class="edit" onclick="marcarBoletoComoPago('${b.id}')">
                 ‚úÖ Marcar como pago
               </button>`
            : ""
        }

        <button class="delete" onclick="excluirBoleto('${b.id}')">
          üóëÔ∏è Excluir
        </button>
      </div>
    `).join("")
}

          }
        </div>
      </div>
    `;
  });
}

window.excluirBoleto = async function (id) {
  const ok = confirm("Deseja excluir este boleto?");
  if (!ok) return;

  try {
    await deleteDoc(doc(db, "boletos", id));
    alert("Boleto exclu√≠do com sucesso!");
    renderBoletosPorAluno();
  } catch (e) {
    console.error(e);
    alert("Erro ao excluir boleto");
  }
};

window.salvarBoletoAluno = function (login) {
  const mes = document.getElementById(`mes-${login}`).value.trim();
  const vencimento = document.getElementById(`venc-${login}`).value;
  const pix = document.getElementById(`pix-${login}`).value.trim();
  const file = document.getElementById(`file-${login}`).files[0];

  if (!mes || !vencimento || !pix || !file) {
    alert("Preencha todos os campos");
    return;
  }

  const reader = new FileReader();
  reader.onload = async () => {
  await addDoc(collection(db, "boletos"), {
  alunoLogin: login,
  mes,
  vencimento,
  pix,
  arquivo: reader.result,
  status: "pendente", // üëà NOVO
  criadoEm: new Date()
});

    renderBoletosPorAluno();
  };

  reader.readAsDataURL(file);
};

/* ================= TAREFAS ‚Äî FIRESTORE ================= */

/* ADICIONAR TAREFA */
window.addTarefa = function (){
    const unidade = unidadeTarefa.value.trim();
    const nome = nomeTarefa.value.trim();
    const nivel = nivelTarefa.value;
    const file = arquivoTarefa.files[0];

    if(!unidade || !nome || !nivel || !file){
        alert("Preencha todos os campos");
        return;
    }

    const reader = new FileReader();
    reader.onload = async () => {
        try {
          await addDoc(collection(db, "tarefas"), {
            unidade,
            nome,
            nivel,
            arquivo: reader.result,
            status: "pendente", // üëà ESSENCIAL
            // criadoEm: new Date()
});

            unidadeTarefa.value = "";
            nomeTarefa.value = "";
            nivelTarefa.value = "";
            arquivoTarefa.value = "";

            alert("Tarefa salva com sucesso!");
            renderTarefasFirestore();

        } catch (e) {
            console.error(e);
            alert("Erro ao salvar tarefa");
        }
    };

    reader.readAsDataURL(file);
};

/* RENDERIZAR TAREFAS */
async function renderTarefasFirestore(){
  listaTarefasAdmin.innerHTML = "";

  const snapshot = await getDocs(collection(db, "tarefas"));

  const tarefasPorNivel = {
    basico: [],
    intermediario: [],
    avancado: []
  };

  snapshot.forEach(docSnap => {
    const t = docSnap.data();
    tarefasPorNivel[t.nivel].push({ ...t, id: docSnap.id });
  });

  const niveis = [
    { id: "basico", nome: "üîµ B√°sico" },
    { id: "intermediario", nome: "üü¢ Intermedi√°rio" },
    { id: "avancado", nome: "üî¥ Avan√ßado" }
  ];

  niveis.forEach((n, index) => {
    const lista = tarefasPorNivel[n.id];
    const id = `tarefas-${index}`;

    listaTarefasAdmin.innerHTML += `
      <div class="card">
        <div class="aluno-header" onclick="toggleBoletos('${id}', this)">
          ${n.nome}
          <span class="seta"></span>
        </div>

        <div class="boletos" id="${id}">
          ${
            lista.length === 0
              ? "<p>Nenhuma tarefa cadastrada.</p>"
              : lista.map(t => `
  <div style="border-top:1px solid #e5e7eb; padding-top:10px; margin-top:10px">
    <strong>${t.unidade}</strong><br>
    ${t.nome}<br>
    <a href="${t.arquivo}" download>üìÑ Baixar</a><br><br>

    <p>
      Status:
      <strong style="color:${t.status === "pago" ? "green" : "red"}">
        ${t.status === "pago" ? "PAGO" : "PENDENTE"}
      </strong>
    </p>

    <button class="edit"
      onclick="marcarComoPago('${t.id}')">
      ‚úÖ Marcar como pago
    </button>

    <button class="delete"
      onclick="excluirTarefa('${t.id}')">
      üóëÔ∏è Excluir tarefa
    </button>
  </div>
`).join("")
          }
        </div>
      </div>
    `;
  });
}
window.marcarComoPago = async function (id) {
  const ok = confirm("Deseja marcar esta tarefa como PAGA?");
  if (!ok) return;

  try {
    await updateDoc(doc(db, "tarefas", id), {
      status: "pago"
    });

    alert("Tarefa marcada como PAGA");
    renderTarefasFirestore();

  } catch (e) {
    console.error(e);
    alert("Erro ao atualizar status da tarefa");
  }
};


window.excluirTarefa = async function (id) {
  const ok = confirm("Deseja excluir esta tarefa?");

  if (!ok) return;

  try {
    await deleteDoc(doc(db, "tarefas", id));
    alert("Tarefa exclu√≠da com sucesso!");
    renderTarefasFirestore();
  } catch (e) {
    console.error(e);
    alert("Erro ao excluir tarefa");
  }
};


/* ================= PROJETOS ‚Äî FIRESTORE ================= */

window.salvarProjeto = function () {
    const nivel = nivelProjeto.value;
    const nome = nomeProjeto.value.trim();
    const desc = descProjeto.value.trim();
    const file = arquivoProjeto.files[0];

    if (!nivel || !nome || !desc || !file) {
        alert("Preencha todos os campos");
        return;
    }

    const reader = new FileReader();
    reader.onload = async () => {
        try {
            await addDoc(collection(db, "projetos"), {
                nivel,
                nome,
                descricao: desc,
                arquivo: reader.result,
                criadoEm: new Date()
            });

            nivelProjeto.value = "";
            nomeProjeto.value = "";
            descProjeto.value = "";
            arquivoProjeto.value = "";

            alert("Projeto salvo com sucesso!");
            renderProjetosFirestore();

        } catch (e) {
            console.error(e);
            alert("Erro ao salvar projeto");
        }
    };

    reader.readAsDataURL(file);
};

async function renderProjetosFirestore(){
    listaProjetos.innerHTML = "";

    const snapshot = await getDocs(collection(db, "projetos"));

    const projetosPorNivel = {
        basico: [],
        intermediario: [],
        avancado: []
    };

    snapshot.forEach(doc => {
        const p = doc.data();
        projetosPorNivel[p.nivel].push(p);
    });

    const niveis = [
        { id: "basico", nome: "üîµ B√°sico" },
        { id: "intermediario", nome: "üü¢ Intermedi√°rio" },
        { id: "avancado", nome: "üî¥ Avan√ßado" }
    ];

    niveis.forEach((n, index) => {
        const lista = projetosPorNivel[n.id];
        const id = `projetos-${index}`;

        listaProjetos.innerHTML += `
        <div class="card">
            <div class="aluno-header" onclick="toggleBoletos('${id}', this)">
                ${n.nome}
                <span class="seta"></span>
            </div>

            <div class="boletos" id="${id}">
                ${
                    lista.length === 0
                    ? "<p>Nenhum projeto cadastrado.</p>"
                    : lista.map(p => `
                        <div style="border-top:1px solid #e5e7eb; padding-top:10px; margin-top:10px">
                            <strong>${p.nome}</strong><br><br>
                            ${p.descricao}<br><br>
                            <a href="${p.arquivo}" download>üìÑ Baixar documento</a>
                        </div>
                    `).join("")
                }
            </div>
        </div>`;
    });
}

window.toggleBoletos = function(id, el){
    const box = document.getElementById(id);
    const aberto = box.style.display === "block";

    box.style.display = aberto ? "none" : "block";
    el.classList.toggle("aberto", !aberto);
};


/* ================= CALEND√ÅRIO ‚Äî FIRESTORE ================= */

const meses = [
  "January","February","March","April","May","June",
  "July","August","September","October","November","December"
];

/* ADICIONAR M√äS */
window.adicionarMes = async function () {
    try {
        const snapshot = await getDocs(collection(db, "calendario"));
        let ultimoMes = null;

        snapshot.forEach(doc => {
            const d = doc.data();
            if (!ultimoMes || (d.ano > ultimoMes.ano || (d.ano === ultimoMes.ano && d.mes > ultimoMes.mes))) {
                ultimoMes = d;
            }
        });

        let mes = ultimoMes ? ultimoMes.mes + 1 : new Date().getMonth();
        let ano = ultimoMes ? ultimoMes.ano : new Date().getFullYear();

        if (mes > 11) {
            mes = 0;
            ano++;
        }

        await addDoc(collection(db, "calendario"), {
            mes,
            ano,
            imagem: null,
            criadoEm: new Date()
        });

        renderCalendarioFirestore();

    } catch (e) {
        console.error(e);
        alert("Erro ao adicionar m√™s");
    }
};

/* SALVAR IMAGEM */
window.salvarImg = async function (id, input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async () => {
        try {
            await updateDoc(doc(db, "calendario", id), {
                imagem: reader.result
            });
            renderCalendarioFirestore();
        } catch (e) {
            console.error(e);
            alert("Erro ao salvar imagem");
        }
    };
    reader.readAsDataURL(file);
};

/* RENDERIZAR */
async function renderCalendarioFirestore() {
    listaMeses.innerHTML = "";

    const snapshot = await getDocs(collection(db, "calendario"));

    const lista = [];
    snapshot.forEach(docu => {
        lista.push({ id: docu.id, ...docu.data() });
    });

    lista.sort((a, b) => a.ano === b.ano ? a.mes - b.mes : a.ano - b.ano);

    lista.forEach(m => {
        listaMeses.innerHTML += `
        <div class="card" style="text-align:center">
            <h1>${meses[m.mes]} ${m.ano}</h1>
            ${m.imagem ? `<img src="${m.imagem}" style="max-width:100%;border-radius:16px">` : ""}
            <input type="file" accept="image/*" onchange="salvarImg('${m.id}', this)">
        </div>`;
    });
}


/* ================= HOR√ÅRIOS ‚Äî FIRESTORE ================= */

const alunoHorario = document.getElementById("alunoHorario");
const tipoAula = document.getElementById("tipoAula");
const qtdAulas = document.getElementById("qtdAulas");
const horariosSemana = document.getElementById("horariosSemana");
const listaHorarios = document.getElementById("listaHorarios");

/* VERIFICA CONFLITO */
async function conflito(dia, inicio, fim){
    const snapshot = await getDocs(collection(db, "horarios"));
    let conflito = false;

    snapshot.forEach(doc => {
        const h = doc.data();
        if (
            h.dia === dia &&
            !(fim <= h.inicio || inicio >= h.fim)
        ) {
            conflito = true;
        }
    });

    return conflito;
}



/* SALVAR HOR√ÅRIO */
window.salvarHorario = async function (){
    const aluno = alunoHorario.value.trim();
    const tipo = tipoAula.value;

    const dias = document.querySelectorAll(".dia");
    const inicios = document.querySelectorAll(".inicio");
    const fins = document.querySelectorAll(".fim");

    if(!aluno || !tipo || dias.length === 0){
        alert("Preencha todos os campos");
        return;
    }

    for(let i = 0; i < dias.length; i++){
        if(!dias[i].value || !inicios[i].value || !fins[i].value){
            alert("Preencha todos os hor√°rios");
            return;
        }

        if(await conflito(dias[i].value, inicios[i].value, fins[i].value)){
            alert(`Hor√°rio indispon√≠vel: ${dias[i].value} ${inicios[i].value}`);
            return;
        }
    }

    for(let i = 0; i < dias.length; i++){
        await addDoc(collection(db, "horarios"), {
            aluno,
            tipo,
            dia: dias[i].value,
            inicio: inicios[i].value,
            fim: fins[i].value,
            criadoEm: new Date()
        });
    }

    alunoHorario.value = "";
    tipoAula.value = "";
    qtdAulas.value = "";
    horariosSemana.innerHTML = "";
    renderHorariosFirestore();

};

/* GERAR CAMPOS */
window.gerarHorarios = function (){
    const qtd = Number(qtdAulas.value);
    horariosSemana.innerHTML = "";

    for(let i = 1; i <= qtd; i++){
        horariosSemana.innerHTML += `
        <div class="card" style="background:#f9fafb">
            <strong>Aula ${i}</strong><br><br>

            <select class="dia">
                <option value="">Dia da semana</option>
                <option>Segunda</option>
                <option>Ter√ßa</option>
                <option>Quarta</option>
                <option>Quinta</option>
                <option>Sexta</option>
            </select>

            <input type="time" class="inicio">
            <input type="time" class="fim">
        </div>`;
    }
};

/* RENDERIZAR */
async function renderHorariosFirestore() {
  listaHorarios.innerHTML = "";

  const snapshot = await getDocs(collection(db, "horarios"));
  if (snapshot.empty) {
    listaHorarios.innerHTML = "<p>Nenhum hor√°rio cadastrado.</p>";
    return;
  }

  const dias = ["Segunda","Ter√ßa","Quarta","Quinta","Sexta","S√°bado","Domingo"];
  const horas = gerarHoras(); // ‚úÖ AQUI ESTAVA FALTANDO

  const aulas = [];
  snapshot.forEach(d => {
    aulas.push({ id: d.id, ...d.data() });
  });

  let html = `<div class="card"><h3>Calend√°rio semanal</h3>`;
  html += `<div class="calendario-grade">`;

  // cabe√ßalho
  html += `<div class="cabecalho celula"></div>`;
  dias.forEach(d => html += `<div class="cabecalho celula">${d}</div>`);

  // linhas
  horas.forEach(hora => {
    html += `<div class="hora celula">${hora}</div>`;

    dias.forEach(dia => {
      const achadas = aulas.filter(a =>
        a.dia === dia &&
        hora >= a.inicio &&
        hora < a.fim
      );

      html += `<div class="celula">
        ${
          achadas.map(a => `
            <div class="aula-grade"
              data-id="${a.id}"
              data-dia="${a.dia}"
              data-inicio="${a.inicio}"
              data-fim="${a.fim}"
              onclick="abrirEdicaoHorario(event)"
            >
              <strong>${a.aluno}</strong><br>
              ${a.tipo}<br>
              ${a.inicio} - ${a.fim}
            </div>
          `).join("")
        }
      </div>`;
    });
  });

  html += `</div></div>`;
  listaHorarios.innerHTML = html;
}



function gerarHoras(inicio = 7, fim = 20) {
  const horas = [];
  for (let h = inicio; h <= fim; h++) {
    horas.push(`${String(h).padStart(2,"0")}:00`);
    if (h !== fim) {
      horas.push(`${String(h).padStart(2,"0")}:30`);
    }
  }
  return horas;
}







window.mostrar = async function(id) {
  document.querySelectorAll('.section').forEach(s => {
    s.classList.remove('active');
  });

  document.getElementById(id).classList.add('active');

  if (id === "pagamentos") {
    await renderBoletosPorAluno();
  }
};

async function preencherSelectHorario() {
  alunoHorario.innerHTML = '<option value="">Selecione o aluno</option>';

  const snapshot = await getDocs(collection(db, "alunos"));

  snapshot.forEach(doc => {
    const a = doc.data();
    alunoHorario.innerHTML += `
      <option value="${a.login}">${a.nome}</option>
    `;
  });
}


async function initDashboard() {
    await renderAlunosFirestore();
     await preencherSelectHorario(); // üëà AQUI
    await renderTarefasFirestore();
    await renderCalendarioFirestore();
    await renderHorariosFirestore();
    await renderBoletosPorAluno();
}

window.addEventListener("DOMContentLoaded", async () => {
    await initDashboard();
});

window.excluirAluno = async function (id, nome) {
  const ok = confirm(
    `Deseja excluir o aluno "${nome}"?\n\n` +
    `‚ö†Ô∏è TODOS os hor√°rios e boletos ser√£o apagados.`
  );
  if (!ok) return;

  try {
    // üî• APAGA HOR√ÅRIOS DO ALUNO
const alunoDoc = await getDocs(collection(db, "alunos"));
let loginAluno = "";

alunoDoc.forEach(d => {
  if (d.id === id) {
    loginAluno = d.data().login;
  }
});

const horariosSnap = await getDocs(collection(db, "horarios"));
for (const docSnap of horariosSnap.docs) {
  if (docSnap.data().aluno === loginAluno) {
    await deleteDoc(doc(db, "horarios", docSnap.id));
  }
}

    // üî• APAGA BOLETOS DO ALUNO
    const boletosSnap = await getDocs(collection(db, "boletos"));
    for (const docSnap of boletosSnap.docs) {
      if (docSnap.data().alunoLogin === loginAluno) {
        await deleteDoc(doc(db, "boletos", docSnap.id));
  }
}

    // üî• APAGA ALUNO
    await deleteDoc(doc(db, "alunos", id));

    alert("Aluno e dados vinculados exclu√≠dos!");
    renderAlunosFirestore();
    renderHorariosFirestore();
    renderBoletosPorAluno();

  } catch (e) {
    console.error(e);
    alert("Erro ao excluir aluno");
  }
};

window.editarAluno = function (id, nome, cpf, nivel) {
    alunoEditandoId = id;

    document.getElementById("alunoNome").value = nome;
    document.getElementById("alunoCpf").value = cpf;
    document.getElementById("alunoNivel").value = nivel;
};

window.editarHorario = async function (id, campo, valor) {
  try {
    await updateDoc(doc(db, "horarios", id), {
      [campo]: valor
    });
  } catch (e) {
    console.error(e);
    alert("Erro ao editar hor√°rio");
  }
};

window.excluirHorario = async function (id) {
  const ok = confirm("Excluir este hor√°rio?");
  if (!ok) return;

  try {
    await deleteDoc(doc(db, "horarios", id));
    renderHorariosFirestore();
  } catch (e) {
    console.error(e);
    alert("Erro ao excluir hor√°rio");
  }
};

window.abrirEdicaoHorario = async function(event) {
  const el = event.currentTarget; // pega sempre a .aula-grade

  const id = el.dataset.id;
  const dia = el.dataset.dia;
  const inicio = el.dataset.inicio;
  const fim = el.dataset.fim;

  if (!id) {
    alert("ID n√£o encontrado");
    return;
  }

  const novoDia = prompt("Dia da semana:", dia);
  if (!novoDia) return;

  const novoInicio = prompt("Hora in√≠cio:", inicio);
  if (!novoInicio) return;

  const novoFim = prompt("Hora fim:", fim);
  if (!novoFim) return;

  try {
    await updateDoc(doc(db, "horarios", id), {
      dia: novoDia,
      inicio: novoInicio,
      fim: novoFim
    });

    alert("Hor√°rio atualizado!");
    renderHorariosFirestore();
  } catch (e) {
    console.error(e);
    alert("Erro ao editar hor√°rio");
  }
};


</script>

</body>
</html>
